<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>MoneyPon</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;800;900&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#051209;--bg2:#081a10;--card:#0d2418;--card2:#112b1e;--green:#00875a;--green2:#00c27a;--gold:#f0b429;--red:#ff4d6d;--blue:#3b82f6;--text:#e8f5ee;--muted:#5a8a6e;--border:rgba(0,194,122,0.08);--border2:rgba(255,255,255,0.06)}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{height:100%;overflow:hidden}
body{background:var(--bg);color:var(--text);font-family:'Plus Jakarta Sans',sans-serif;font-size:14px}
input,button,select,textarea{font-family:'Plus Jakarta Sans',sans-serif}
button{cursor:pointer;border:none;outline:none}
input{outline:none}
#app{width:100%;max-width:430px;height:100vh;margin:0 auto;position:relative;overflow:hidden;background:var(--bg)}
.screen{position:absolute;top:0;left:0;width:100%;height:100%;display:none;flex-direction:column;background:var(--bg)}
.screen.active{display:flex}
.scroll-area{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;padding-bottom:20px}
.topbar{background:var(--bg2);padding:50px 18px 14px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;border-bottom:1px solid var(--border)}
.topbar-logo{font-family:'Playfair Display',serif;font-size:1.3rem;font-weight:900;background:linear-gradient(135deg,var(--gold),var(--green2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.topbar-title{font-size:0.9rem;font-weight:700}
.topbar-back{background:none;color:var(--green2);font-size:0.85rem;font-weight:600;padding:4px 8px;border-radius:8px}
.topbar-icon-btn{width:32px;height:32px;background:rgba(255,255,255,0.05);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.85rem;cursor:pointer}
.bottom-nav{background:var(--bg2);display:flex;border-top:1px solid var(--border);padding:10px 0 24px;flex-shrink:0}
.nav-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;padding:4px 0}
.nav-icon{font-size:1.1rem}
.nav-label{font-size:0.55rem;color:var(--muted);font-weight:600}
.nav-item.active .nav-label{color:var(--green2)}
.nav-center-wrap{flex:1;display:flex;flex-direction:column;align-items:center;margin-top:-20px;cursor:pointer}
.nav-center-btn{width:44px;height:44px;background:linear-gradient(135deg,var(--green),var(--green2));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;box-shadow:0 4px 20px rgba(0,194,122,0.4);border:3px solid var(--bg2)}
.nav-center-label{font-size:0.52rem;color:var(--green2);font-weight:700;margin-top:3px}
.btn{width:100%;padding:14px;border-radius:12px;font-size:0.9rem;font-weight:700;transition:all 0.2s}
.btn:active{transform:scale(0.97)}
.btn-green{background:linear-gradient(135deg,var(--green),var(--green2));color:#fff;box-shadow:0 4px 20px rgba(0,194,122,0.3)}
.btn-gold{background:linear-gradient(135deg,#d4900a,var(--gold));color:#000}
.btn-outline{background:transparent;border:1.5px solid var(--green2);color:var(--green2)}
.btn-red{background:rgba(255,77,109,0.15);border:1px solid rgba(255,77,109,0.3);color:var(--red)}
.input-group{margin-bottom:14px}
.input-label{font-size:0.7rem;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;display:block}
.input-field{width:100%;background:var(--card);border:1.5px solid var(--border2);border-radius:10px;padding:12px 14px;color:var(--text);font-size:0.88rem;transition:border-color 0.2s}
.input-field:focus{border-color:var(--green2)}
.input-field::placeholder{color:var(--muted)}
select.input-field option{background:var(--card)}
.section-title{font-size:0.68rem;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1.2px;margin:16px 0 8px;padding:0 16px}
.badge{display:inline-flex;align-items:center;padding:3px 10px;border-radius:20px;font-size:0.65rem;font-weight:700}
.badge-green{background:rgba(0,194,122,0.15);color:var(--green2);border:1px solid rgba(0,194,122,0.25)}
.badge-gold{background:rgba(240,180,41,0.15);color:var(--gold);border:1px solid rgba(240,180,41,0.25)}
.badge-red{background:rgba(255,77,109,0.15);color:var(--red);border:1px solid rgba(255,77,109,0.25)}
.badge-blue{background:rgba(59,130,246,0.15);color:var(--blue);border:1px solid rgba(59,130,246,0.25)}
.badge-muted{background:rgba(255,255,255,0.06);color:var(--muted);border:1px solid var(--border2)}
#toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:#1a3a2a;border:1px solid var(--green2);color:var(--text);padding:10px 20px;border-radius:25px;font-size:0.82rem;font-weight:600;z-index:9999;opacity:0;transition:opacity 0.3s;white-space:nowrap;pointer-events:none;max-width:90%}
#toast.show{opacity:1}
#loading-overlay{position:fixed;inset:0;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9998;transition:opacity 0.5s}
#loading-overlay.hidden{opacity:0;pointer-events:none}
.loader-logo{font-family:'Playfair Display',serif;font-size:2.5rem;font-weight:900;background:linear-gradient(135deg,var(--gold),var(--green2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:8px}
.loader-sub{font-size:0.75rem;color:var(--muted);letter-spacing:2px;text-transform:uppercase}
.loader-spinner{width:32px;height:32px;border:2px solid rgba(0,194,122,0.2);border-top-color:var(--green2);border-radius:50%;animation:spin 0.8s linear infinite;margin-top:24px}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.7}}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-8px)}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0.2}}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:9000;display:none;align-items:flex-end;justify-content:center}
.modal-overlay.open{display:flex}
.modal-sheet{background:var(--bg2);border-radius:24px 24px 0 0;padding:20px 20px 40px;width:100%;max-width:430px;border-top:1px solid var(--border);animation:slideUp 0.3s ease}
.modal-handle{width:40px;height:4px;background:rgba(255,255,255,0.15);border-radius:2px;margin:0 auto 16px}
.modal-title{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:800;margin-bottom:16px;color:var(--gold)}
.live-dot{display:inline-block;width:6px;height:6px;background:var(--green2);border-radius:50%;animation:blink 2s infinite}
.auth-header{padding:60px 24px 24px;background:linear-gradient(180deg,var(--bg2),var(--bg))}
.auth-title{font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:900;background:linear-gradient(135deg,var(--gold),var(--green2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:4px}
.auth-sub{font-size:0.82rem;color:var(--muted)}
.auth-body{padding:24px;flex:1;overflow-y:auto}
.auth-footer{padding:16px 24px 32px;text-align:center;font-size:0.8rem;color:var(--muted)}
.auth-link{color:var(--green2);font-weight:700;cursor:pointer}
.balance-hero{margin:16px;background:linear-gradient(135deg,#003d22,#005c33);border-radius:20px;padding:20px;position:relative;overflow:hidden;border:1px solid rgba(0,194,122,0.2)}
.balance-greeting{font-size:0.72rem;color:rgba(255,255,255,0.5);margin-bottom:2px}
.balance-name{font-size:0.92rem;font-weight:700;margin-bottom:12px}
.balance-amount-label{font-size:0.62rem;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:0.8px}
.balance-amount{font-family:'Playfair Display',serif;font-size:2rem;font-weight:900;color:var(--gold);margin:2px 0 14px}
.balance-actions{display:flex;gap:8px}
.balance-action{flex:1;background:rgba(255,255,255,0.08);border-radius:10px;padding:8px 4px;text-align:center;border:1px solid rgba(255,255,255,0.05);cursor:pointer}
.ba-icon{font-size:1.1rem}
.ba-label{font-size:0.58rem;color:rgba(255,255,255,0.6);margin-top:3px;font-weight:600}
.rate-bar{margin:0 16px 16px;background:var(--card);border-radius:12px;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;border:1px solid rgba(240,180,41,0.12)}
.rate-value{font-family:'Playfair Display',serif;font-size:0.95rem;font-weight:800;color:var(--gold)}
.rate-label{font-size:0.6rem;color:var(--muted);margin-bottom:2px}
.rate-live{font-size:0.62rem;color:var(--green2);display:flex;align-items:center;gap:4px}
.quick-actions{margin:0 16px 16px;display:grid;grid-template-columns:1fr 1fr;gap:10px}
.quick-action-card{background:var(--card);border-radius:14px;padding:14px;border:1px solid var(--border);cursor:pointer}
.qa-icon{font-size:1.4rem;margin-bottom:6px}
.qa-title{font-size:0.78rem;font-weight:700;margin-bottom:2px}
.qa-sub{font-size:0.62rem;color:var(--muted)}
.tx-item{background:var(--card);border-radius:12px;padding:12px;margin:0 16px 8px;display:flex;align-items:center;gap:12px;border:1px solid var(--border2);cursor:pointer}
.tx-icon-wrap{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0}
.tx-info{flex:1;min-width:0}
.tx-title{font-size:0.82rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tx-date{font-size:0.65rem;color:var(--muted);margin-top:2px}
.tx-amount{font-family:'Playfair Display',serif;font-size:0.9rem;font-weight:800;white-space:nowrap}
.amount-block{margin:0 16px;background:var(--card);border-radius:16px;border:1.5px solid rgba(0,194,122,0.15);overflow:hidden}
.amount-row{padding:14px 16px}
.amount-row+.amount-row{border-top:1px solid var(--border2)}
.amount-row-label{font-size:0.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px}
.amount-input-large{width:100%;background:transparent;border:none;font-family:'Playfair Display',serif;font-size:2rem;font-weight:900;color:var(--text)}
.amount-input-large::placeholder{color:rgba(255,255,255,0.15)}
.amount-currency-tag{font-size:0.72rem;color:var(--muted);margin-top:3px}
.swap-btn-row{text-align:center;padding:4px;background:var(--card2)}
.fee-summary{margin:12px 16px;background:rgba(0,194,122,0.05);border:1px solid rgba(0,194,122,0.12);border-radius:12px;padding:12px 14px}
.fee-row{display:flex;justify-content:space-between;font-size:0.78rem;margin-bottom:6px}
.fee-label{color:var(--muted)}
.fee-value{font-weight:600}
.fee-divider{height:1px;background:rgba(0,194,122,0.1);margin:8px 0}
.fee-total{display:flex;justify-content:space-between;font-size:0.85rem;font-weight:800}
.fee-total .fee-value{color:var(--green2)}
.search-bar-wrap{margin:12px 16px;position:relative}
.search-bar{width:100%;background:var(--card);border:1.5px solid var(--border2);border-radius:12px;padding:11px 14px 11px 40px;color:var(--text);font-size:0.85rem}
.search-bar:focus{border-color:var(--green2)}
.search-icon{position:absolute;left:14px;top:50%;transform:translateY(-50%);font-size:0.85rem;color:var(--muted)}
.filter-chips{display:flex;gap:8px;margin:0 16px 12px;overflow-x:auto;padding-bottom:4px}
.filter-chip{flex-shrink:0;padding:5px 12px;border-radius:20px;font-size:0.7rem;font-weight:600;background:var(--card);color:var(--muted);border:1px solid var(--border2);cursor:pointer}
.filter-chip.active{background:rgba(0,194,122,0.15);color:var(--green2);border-color:rgba(0,194,122,0.3)}
.agent-card{margin:0 16px 10px;background:var(--card);border-radius:14px;padding:14px;border:1px solid var(--border2);cursor:pointer}
.agent-card-top{display:flex;align-items:center;gap:12px;margin-bottom:10px}
.agent-avatar{width:44px;height:44px;background:rgba(0,194,122,0.1);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;border:1px solid rgba(0,194,122,0.15);position:relative}
.agent-online-dot{position:absolute;bottom:2px;right:2px;width:10px;height:10px;background:var(--green2);border-radius:50%;border:2px solid var(--card)}
.agent-card-info{flex:1}
.agent-card-name{font-size:0.88rem;font-weight:700;margin-bottom:2px}
.agent-card-location{font-size:0.68rem;color:var(--muted)}
.agent-card-stats{display:flex;gap:6px}
.agent-stat-pill{background:var(--card2);border-radius:8px;padding:5px 8px;font-size:0.65rem;color:var(--muted);border:1px solid var(--border2)}
.agent-stat-pill span{color:var(--text);font-weight:700}
.agent-call-btn{background:rgba(0,194,122,0.1);border:1px solid rgba(0,194,122,0.2);color:var(--green2);border-radius:8px;padding:5px 10px;font-size:0.68rem;font-weight:700;cursor:pointer}
.info-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border2)}
.info-row:last-child{border-bottom:none}
.info-row-label{font-size:0.72rem;color:var(--muted)}
.info-row-value{font-size:0.82rem;font-weight:600}
.date-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin:0 16px 16px}
.date-cell{aspect-ratio:1;border-radius:10px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;border:1.5px solid transparent;background:var(--card)}
.date-cell.selected{background:rgba(0,194,122,0.15);border-color:var(--green2)}
.date-day{font-size:0.52rem;color:var(--muted)}
.date-num{font-size:0.82rem;font-weight:700}
.time-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin:0 16px 16px}
.time-cell{padding:8px;border-radius:10px;text-align:center;font-size:0.78rem;font-weight:600;background:var(--card);border:1.5px solid transparent;cursor:pointer}
.time-cell.selected{background:rgba(0,194,122,0.15);border-color:var(--green2);color:var(--green2)}
.tl-item{display:flex;gap:14px;padding-bottom:16px}
.tl-item:last-child{padding-bottom:0}
.tl-left{display:flex;flex-direction:column;align-items:center}
.tl-dot{width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.65rem;flex-shrink:0}
.tl-dot.done{background:var(--green);color:#fff}
.tl-dot.active{background:var(--gold);color:#000;animation:pulse 1.5s infinite}
.tl-dot.waiting{background:rgba(255,255,255,0.07);color:var(--muted);border:1.5px solid var(--border2)}
.tl-line{flex:1;width:1.5px;background:var(--border2);margin:2px 0;min-height:20px}
.tl-line.done{background:var(--green);opacity:0.4}
.tl-right{flex:1;padding-top:2px}
.tl-title{font-size:0.82rem;font-weight:700}
.tl-title.active{color:var(--gold)}
.tl-title.waiting{color:var(--muted)}
.tl-sub{font-size:0.68rem;color:var(--muted);margin-top:3px}
.request-card{margin:0 16px 10px;background:var(--card);border-radius:14px;padding:14px;border:1px solid var(--border2)}
.request-card-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.request-ref{font-size:0.65rem;color:var(--muted);font-family:monospace}
.request-amount{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:900;color:var(--gold);margin-bottom:4px}
.request-btns{display:flex;gap:8px;margin-top:10px}
.req-btn-confirm{flex:2;padding:9px;background:rgba(0,194,122,0.15);border:1px solid rgba(0,194,122,0.3);color:var(--green2);border-radius:10px;font-size:0.78rem;font-weight:700;cursor:pointer}
.req-btn-decline{flex:1;padding:9px;background:rgba(255,77,109,0.08);border:1px solid rgba(255,77,109,0.2);color:var(--red);border-radius:10px;font-size:0.78rem;font-weight:700;cursor:pointer}
.admin-stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:16px}
.admin-stat-card{background:var(--card);border-radius:14px;padding:14px;border:1px solid var(--border2)}
.admin-stat-icon{font-size:1.2rem;margin-bottom:6px}
.admin-stat-val{font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:900;color:var(--gold);margin-bottom:2px}
.admin-stat-lbl{font-size:0.62rem;color:var(--muted)}
.admin-action-row{margin:0 16px 8px;background:var(--card);border-radius:12px;padding:12px 14px;display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border2)}
.admin-action-info{flex:1}
.admin-action-name{font-size:0.82rem;font-weight:700;margin-bottom:2px}
.admin-action-sub{font-size:0.65rem;color:var(--muted)}
.admin-action-btns{display:flex;gap:6px;flex-shrink:0}
.admin-btn-approve{padding:6px 12px;background:rgba(0,194,122,0.15);border:1px solid rgba(0,194,122,0.25);color:var(--green2);border-radius:8px;font-size:0.68rem;font-weight:700;cursor:pointer}
.admin-btn-reject{padding:6px 12px;background:rgba(255,77,109,0.1);border:1px solid rgba(255,77,109,0.2);color:var(--red);border-radius:8px;font-size:0.68rem;font-weight:700;cursor:pointer}
.admin-btn-block{padding:6px 12px;background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.2);color:orange;border-radius:8px;font-size:0.68rem;font-weight:700;cursor:pointer}
.profile-hero{margin:16px;background:linear-gradient(135deg,#003d22,#004d2a);border-radius:20px;padding:20px;text-align:center;border:1px solid rgba(0,194,122,0.12)}
.profile-avatar{width:56px;height:56px;background:rgba(240,180,41,0.15);border-radius:16px;display:flex;align-items:center;justify-content:center;font-size:1.6rem;margin:0 auto 10px}
.profile-name{font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:900;margin-bottom:2px}
.profile-email{font-size:0.72rem;color:rgba(255,255,255,0.4);margin-bottom:12px}
.profile-stats{display:flex}
.profile-stat{flex:1;text-align:center;padding:8px}
.profile-stat+.profile-stat{border-left:1px solid rgba(255,255,255,0.08)}
.profile-stat .v{font-family:'Playfair Display',serif;font-size:0.9rem;font-weight:800;color:var(--gold)}
.profile-stat .l{font-size:0.55rem;color:rgba(255,255,255,0.35)}
.menu-row{background:var(--card);border-radius:12px;padding:13px 14px;margin:0 16px 4px;display:flex;align-items:center;gap:12px;border:1px solid var(--border2);cursor:pointer}
.menu-row-icon{font-size:1rem;width:24px;text-align:center}
.menu-row-text{flex:1;font-size:0.82rem;font-weight:600}
.menu-row-arrow{font-size:0.7rem;color:var(--muted)}
.empty-state{text-align:center;padding:40px 20px}
.empty-icon{font-size:2.5rem;margin-bottom:10px;opacity:0.5}
.empty-title{font-size:0.9rem;font-weight:700;color:var(--muted);margin-bottom:4px}
.empty-sub{font-size:0.75rem;color:var(--muted);opacity:0.7}
.history-item{margin:0 16px 8px;background:var(--card);border-radius:12px;padding:12px;border:1px solid var(--border2);cursor:pointer}
.history-item-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px}
.history-item-name{font-size:0.82rem;font-weight:700}
.history-item-bottom{display:flex;justify-content:space-between}
.history-item-meta{font-size:0.65rem;color:var(--muted)}
.history-item-amount{font-family:'Playfair Display',serif;font-size:0.88rem;font-weight:800;color:var(--green2)}
.agent-hero{margin:16px;background:linear-gradient(135deg,#2d1b00,#5c3800);border-radius:18px;padding:18px;border:1px solid rgba(240,180,41,0.15)}
.user-info-box{background:rgba(0,194,122,0.06);border:1px solid rgba(0,194,122,0.12);border-radius:10px;padding:10px;margin-bottom:10px}
</style>
</head>
<body>
<div id="loading-overlay">
  <div class="loader-logo">MoneyPon</div>
  <div class="loader-sub">Pon Lajan Ou</div>
  <div class="loader-spinner"></div>
</div>
<div id="toast"></div>

<!-- MODALS -->
<div class="modal-overlay" id="modal-confirm-cash">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">âœ… Confirm Cash Received</div>
    <div class="input-group"><label class="input-label">Amount Received (USD)</label><input type="number" class="input-field" id="confirm-cash-amount" placeholder="e.g. 200"></div>
    <input type="hidden" id="confirm-cash-txid">
    <div style="background:rgba(240,180,41,0.08);border:1px solid rgba(240,180,41,0.15);border-radius:10px;padding:10px;margin-bottom:14px;font-size:0.75rem;color:rgba(240,180,41,0.8)">âš ï¸ Enter exact amount. Admin verifies before releasing.</div>
    <button class="btn btn-gold" onclick="submitCashConfirmation()">Confirm I Received Cash</button>
    <button class="btn btn-outline" style="margin-top:8px" onclick="closeModal('modal-confirm-cash')">Cancel</button>
  </div>
</div>

<div class="modal-overlay" id="modal-call-agent">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ“ Call Agent</div>
    <div id="modal-agent-info" style="margin-bottom:16px"></div>
    <button class="btn btn-green" id="modal-call-btn" onclick="callAgent()">ğŸ“ Call Now</button>
    <button class="btn btn-outline" style="margin-top:8px" onclick="closeModal('modal-call-agent')">Close</button>
  </div>
</div>

<div class="modal-overlay" id="modal-book-confirm">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸ“… Confirm Appointment</div>
    <div id="book-summary" style="margin-bottom:16px"></div>
    <button class="btn btn-green" onclick="confirmBooking()">âœ… Confirm Appointment</button>
    <button class="btn btn-outline" style="margin-top:8px" onclick="closeModal('modal-book-confirm')">Cancel</button>
  </div>
</div>

<div class="modal-overlay" id="modal-admin-release">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">ğŸš€ Release Transfer</div>
    <div id="release-info" style="margin-bottom:16px"></div>
    <div style="background:rgba(0,194,122,0.06);border:1px solid rgba(0,194,122,0.15);border-radius:10px;padding:10px;margin-bottom:14px;font-size:0.75rem;color:var(--green2)">âœ… Confirm USA agent should send Zelle now.</div>
    <button class="btn btn-green" onclick="releaseTx()">Release & Notify USA Agent</button>
    <button class="btn btn-red" style="margin-top:8px" onclick="flagTx()">ğŸš© Flag Transaction</button>
    <button class="btn btn-outline" style="margin-top:8px" onclick="closeModal('modal-admin-release')">Cancel</button>
  </div>
</div>

<div id="app">

<!-- SPLASH -->
<div class="screen active" id="screen-splash">
  <div style="position:absolute;inset:0;background:radial-gradient(ellipse at 30% 20%,rgba(0,194,122,0.08),transparent 60%),radial-gradient(ellipse at 70% 80%,rgba(240,180,41,0.06),transparent 60%)"></div>
  <div style="position:relative;z-index:1;text-align:center;padding:40px 32px;display:flex;flex-direction:column;align-items:center;height:100%;justify-content:center">
    <div style="font-size:3rem;margin-bottom:40px;animation:float 3s ease-in-out infinite">ğŸ¦</div>
    <div style="font-family:'Playfair Display',serif;font-size:3rem;font-weight:900;background:linear-gradient(135deg,var(--gold),var(--green2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:6px">MoneyPon</div>
    <div style="font-size:0.85rem;color:var(--muted);margin-bottom:50px">Pon lajan ou â€” <span style="color:var(--green2);font-weight:600">Bridge your money</span><br>Haiti ğŸ‡­ğŸ‡¹ â†” USA ğŸ‡ºğŸ‡¸</div>
    <div style="width:100%;display:flex;flex-direction:column;gap:12px">
      <button class="btn btn-green" onclick="showScreen('screen-login')">Konekte â€” Sign In</button>
      <button class="btn btn-outline" onclick="showScreen('screen-register')">Kreye Kont â€” Register</button>
    </div>
    <div style="margin-top:16px;font-size:0.72rem;color:var(--muted)">Faster & cheaper than Western Union</div>
  </div>
</div>

<!-- LOGIN -->
<div class="screen" id="screen-login">
  <div class="auth-header">
    <div style="margin-bottom:8px"><button class="topbar-back" onclick="showScreen('screen-splash')">â† Back</button></div>
    <div class="auth-title">Bon Retou ğŸ‘‹</div>
    <div class="auth-sub">Sign in to your MoneyPon account</div>
  </div>
  <div class="auth-body scroll-area">
    <div class="input-group"><label class="input-label">Email</label><input type="email" class="input-field" id="login-email" placeholder="yourname@email.com"></div>
    <div class="input-group"><label class="input-label">Password</label><input type="password" class="input-field" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"></div>
    <button class="btn btn-green" onclick="loginUser()">Konekte â€” Sign In</button>
    <div style="text-align:center;margin-top:14px;font-size:0.78rem;color:var(--muted)">â€” or â€”</div>
    <button class="btn btn-outline" style="margin-top:10px" onclick="loginAsAdmin()">âš™ï¸ Admin Login</button>
  </div>
  <div class="auth-footer">Pa gen kont? <span class="auth-link" onclick="showScreen('screen-register')">Create Account</span></div>
</div>

<!-- REGISTER -->
<div class="screen" id="screen-register">
  <div class="auth-header">
    <div style="margin-bottom:8px"><button class="topbar-back" onclick="showScreen('screen-splash')">â† Back</button></div>
    <div class="auth-title">Kreye Kont âœ¨</div>
    <div class="auth-sub">Create your free MoneyPon account</div>
  </div>
  <div class="auth-body scroll-area">
    <div class="input-group"><label class="input-label">Full Name</label><input type="text" class="input-field" id="reg-name" placeholder="e.g. Jean Baptiste"></div>
    <div class="input-group"><label class="input-label">Email</label><input type="email" class="input-field" id="reg-email" placeholder="yourname@email.com"></div>
    <div class="input-group"><label class="input-label">Phone</label><input type="tel" class="input-field" id="reg-phone" placeholder="+509 or +1..."></div>
    <div class="input-group"><label class="input-label">Password</label><input type="password" class="input-field" id="reg-password" placeholder="Min 6 characters"></div>
    <div class="input-group">
      <label class="input-label">Register as</label>
      <select class="input-field" id="reg-role" onchange="toggleAgentFields()">
        <option value="user">ğŸ‘¤ Regular User â€” Send Money</option>
        <option value="agent_pending">ğŸ¤ Agent â€” Handle Transfers</option>
      </select>
    </div>
    <div id="agent-extra" style="display:none">
      <div class="input-group">
        <label class="input-label">Your Location</label>
        <select class="input-field" id="reg-location">
          <option value="">Select location</option>
          <option value="Port-au-Prince, Haiti">ğŸ‡­ğŸ‡¹ Port-au-Prince, Haiti</option>
          <option value="Cap-HaÃ¯tien, Haiti">ğŸ‡­ğŸ‡¹ Cap-HaÃ¯tien, Haiti</option>
          <option value="GonaÃ¯ves, Haiti">ğŸ‡­ğŸ‡¹ GonaÃ¯ves, Haiti</option>
          <option value="New York, USA">ğŸ‡ºğŸ‡¸ New York, USA</option>
          <option value="Miami, USA">ğŸ‡ºğŸ‡¸ Miami, USA</option>
          <option value="Boston, USA">ğŸ‡ºğŸ‡¸ Boston, USA</option>
          <option value="Orlando, USA">ğŸ‡ºğŸ‡¸ Orlando, USA</option>
        </select>
      </div>
      <div class="input-group"><label class="input-label">Zelle / MonCash Number</label><input type="text" class="input-field" id="reg-zelle" placeholder="Your Zelle email or MonCash number"></div>
      <div style="background:rgba(240,180,41,0.08);border:1px solid rgba(240,180,41,0.15);border-radius:10px;padding:10px;margin-bottom:14px;font-size:0.75rem;color:rgba(240,180,41,0.8)">â³ Agent accounts require admin approval.</div>
    </div>
    <button class="btn btn-green" onclick="registerUser()">Kreye Kont â€” Create Account</button>
  </div>
  <div class="auth-footer">Deja gen kont? <span class="auth-link" onclick="showScreen('screen-login')">Sign In</span></div>
</div>

<!-- USER HOME -->
<div class="screen" id="screen-user-home">
  <div class="topbar"><span class="topbar-logo">MoneyPon</span><div class="topbar-icon-btn">ğŸ””</div></div>
  <div class="scroll-area">
    <div class="balance-hero">
      <div class="balance-greeting">Bonjou,</div>
      <div class="balance-name" id="home-user-name">...</div>
      <div class="balance-amount-label">Total Sent</div>
      <div class="balance-amount" id="home-total-sent">$0.00</div>
      <div class="balance-actions">
        <div class="balance-action" onclick="showScreen('screen-send-money')"><div class="ba-icon">ğŸ“¤</div><div class="ba-label">Send</div></div>
        <div class="balance-action" onclick="showScreen('screen-agents');loadAgents()"><div class="ba-icon">ğŸ¤</div><div class="ba-label">Agents</div></div>
        <div class="balance-action" onclick="showScreen('screen-history');loadHistory()"><div class="ba-icon">ğŸ“‹</div><div class="ba-label">History</div></div>
      </div>
    </div>
    <div class="rate-bar">
      <div><div class="rate-label">Today's Rate</div><div class="rate-value">1 USD = 131 HTG</div></div>
      <div style="text-align:right"><div class="rate-live"><span class="live-dot"></span> Live</div></div>
    </div>
    <div class="section-title">Quick Actions</div>
    <div class="quick-actions">
      <div class="quick-action-card" onclick="showScreen('screen-send-money')"><div class="qa-icon">ğŸ’¸</div><div class="qa-title">Send Money</div><div class="qa-sub">Haiti â†’ USA</div></div>
      <div class="quick-action-card" onclick="showScreen('screen-agents');loadAgents()"><div class="qa-icon">ğŸ—‚ï¸</div><div class="qa-title">Find Agent</div><div class="qa-sub">Browse nearby</div></div>
      <div class="quick-action-card" onclick="showScreen('screen-history');loadHistory()"><div class="qa-icon">ğŸ“Š</div><div class="qa-title">My Transfers</div><div class="qa-sub">Track history</div></div>
      <div class="quick-action-card" onclick="showScreen('screen-profile');loadProfileHero()"><div class="qa-icon">ğŸ‘¤</div><div class="qa-title">My Profile</div><div class="qa-sub">Account info</div></div>
    </div>
    <div class="section-title">Recent Transfers</div>
    <div id="home-tx-list"><div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-title">No transfers yet</div><div class="empty-sub">Start your first one!</div></div></div>
  </div>
  <div class="bottom-nav">
    <div class="nav-item active" onclick="showScreen('screen-user-home')"><span class="nav-icon">ğŸ </span><span class="nav-label">Home</span></div>
    <div class="nav-item" onclick="showScreen('screen-send-money')"><span class="nav-icon">ğŸ“¤</span><span class="nav-label">Send</span></div>
    <div class="nav-center-wrap" onclick="showScreen('screen-agents');loadAgents()"><div class="nav-center-btn">ğŸ¤</div><span class="nav-center-label">Agents</span></div>
    <div class="nav-item" onclick="showScreen('screen-history');loadHistory()"><span class="nav-icon">ğŸ“‹</span><span class="nav-label">History</span></div>
    <div class="nav-item" onclick="showScreen('screen-profile');loadProfileHero()"><span class="nav-icon">ğŸ‘¤</span><span class="nav-label">Profile</span></div>
  </div>
</div>

<!-- SEND MONEY -->
<div class="screen" id="screen-send-money">
  <div class="topbar"><button class="topbar-back" onclick="goBack()">â† Back</button><span class="topbar-title">Send Money</span><div style="width:60px"></div></div>
  <div class="scroll-area" style="padding-bottom:30px">
    <div style="margin:16px;background:linear-gradient(135deg,#002d18,#003d22);border-radius:16px;padding:14px;text-align:center;border:1px solid rgba(0,194,122,0.15)">
      <div style="font-size:0.62rem;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px">Transfer Direction</div>
      <div style="font-family:'Playfair Display',serif;font-size:1rem;font-weight:800;color:var(--gold)">ğŸ‡­ğŸ‡¹ Haiti â†’ USA ğŸ‡ºğŸ‡¸</div>
    </div>
    <div class="amount-block">
      <div class="amount-row"><div class="amount-row-label">You Send (USD Cash to Haiti Agent)</div><input type="number" class="amount-input-large" id="send-amount" placeholder="0" oninput="calculateTransfer()"><div class="amount-currency-tag">Pay cash in person to Haiti agent</div></div>
      <div class="swap-btn-row"><span style="background:rgba(0,194,122,0.15);border:1px solid rgba(0,194,122,0.2);color:var(--green2);width:28px;height:28px;border-radius:50%;font-size:0.85rem;display:inline-flex;align-items:center;justify-content:center">â¬‡</span></div>
      <div class="amount-row"><div class="amount-row-label">Recipient Gets (via Zelle)</div><div class="amount-input-large" id="receive-amount" style="color:var(--gold)">0</div><div class="amount-currency-tag">Sent to recipient's Zelle in USA</div></div>
    </div>
    <div class="fee-summary">
      <div class="fee-row"><span class="fee-label">You Send</span><span class="fee-value" id="fee-send">$0.00</span></div>
      <div class="fee-row"><span class="fee-label">Fee (15%)</span><span class="fee-value" style="color:var(--red)" id="fee-amount">-$0.00</span></div>
      <div class="fee-divider"></div>
      <div class="fee-total"><span>Recipient Gets</span><span class="fee-value" id="fee-receive">$0.00</span></div>
    </div>
    <div style="padding:0 16px">
      <div class="input-group"><label class="input-label">Recipient Full Name</label><input type="text" class="input-field" id="recipient-name" placeholder="Who is receiving?"></div>
      <div class="input-group"><label class="input-label">Recipient Zelle (USA)</label><input type="text" class="input-field" id="recipient-zelle" placeholder="Phone or email"></div>
      <div class="input-group"><label class="input-label">Note (Optional)</label><input type="text" class="input-field" id="send-note" placeholder="e.g. For school fees..."></div>
      <button class="btn btn-green" onclick="proceedToAgent()">Continue â€” Find Agent ğŸ¤</button>
    </div>
  </div>
</div>

<!-- AGENTS -->
<div class="screen" id="screen-agents">
  <div class="topbar"><button class="topbar-back" onclick="goBack()">â† Back</button><span class="topbar-title">Find Agent</span><div style="width:60px"></div></div>
  <div class="scroll-area">
    <div class="search-bar-wrap"><span class="search-icon">ğŸ”</span><input type="text" class="search-bar" placeholder="Search by name or location..." oninput="filterAgents(this.value)"></div>
    <div class="filter-chips">
      <div class="filter-chip active" onclick="filterByCountry('all',this)">ğŸŒ All</div>
      <div class="filter-chip" onclick="filterByCountry('haiti',this)">ğŸ‡­ğŸ‡¹ Haiti</div>
      <div class="filter-chip" onclick="filterByCountry('usa',this)">ğŸ‡ºğŸ‡¸ USA</div>
      <div class="filter-chip" onclick="filterByCountry('online',this)">ğŸŸ¢ Available</div>
    </div>
    <div class="section-title">Available Agents</div>
    <div id="agents-list"><div style="text-align:center;padding:40px;color:var(--muted)">â³ Loading...</div></div>
  </div>
  <div class="bottom-nav">
    <div class="nav-item" onclick="showScreen('screen-user-home')"><span class="nav-icon">ğŸ </span><span class="nav-label">Home</span></div>
    <div class="nav-item" onclick="showScreen('screen-send-money')"><span class="nav-icon">ğŸ“¤</span><span class="nav-label">Send</span></div>
    <div class="nav-center-wrap"><div class="nav-center-btn">ğŸ¤</div><span class="nav-center-label">Agents</span></div>
    <div class="nav-item" onclick="showScreen('screen-history');loadHistory()"><span class="nav-icon">ğŸ“‹</span><span class="nav-label">History</span></div>
    <div class="nav-item" onclick="showScreen('screen-profile');loadProfileHero()"><span class="nav-icon">ğŸ‘¤</span><span class="nav-label">Profile</span></div>
  </div>
</div>

<!-- AGENT PROFILE -->
<div class="screen" id="screen-agent-profile">
  <div class="topbar"><button class="topbar-back" onclick="goBack()">â† Back</button><span class="topbar-title">Agent Profile</span><div style="width:60px"></div></div>
  <div class="scroll-area"><div id="agent-profile-content"></div></div>
</div>

<!-- SCHEDULE -->
<div class="screen" id="screen-schedule">
  <div class="topbar"><button class="topbar-back" onclick="goBack()">â† Back</button><span class="topbar-title">Book Appointment</span><div style="width:60px"></div></div>
  <div class="scroll-area" style="padding-bottom:30px">
    <div style="padding:12px 16px 0"><div id="schedule-agent-mini"></div></div>
    <div class="section-title">Pick a Date</div>
    <div class="date-grid" id="date-grid"></div>
    <div class="section-title">Pick a Time</div>
    <div class="time-grid" id="time-grid"></div>
    <div style="padding:0 16px">
      <div class="input-group"><label class="input-label">Amount You'll Bring (USD)</label><input type="number" class="input-field" id="appt-amount" placeholder="e.g. 200"></div>
      <div class="input-group"><label class="input-label">Note for Agent</label><input type="text" class="input-field" id="appt-note" placeholder="Optional message..."></div>
      <button class="btn btn-green" onclick="showBookingConfirm()">Book Appointment</button>
    </div>
  </div>
</div>

<!-- TRACK -->
<div class="screen" id="screen-track">
  <div class="topbar"><button class="topbar-back" onclick="goBack()">â† Back</button><span class="topbar-title">Track Transfer</span><div style="width:60px"></div></div>
  <div class="scroll-area" id="track-content"></div>
</div>

<!-- HISTORY -->
<div class="screen" id="screen-history">
  <div class="topbar"><button class="topbar-back" onclick="goBack()">â† Back</button><span class="topbar-title">History</span><div style="width:60px"></div></div>
  <div class="scroll-area"><div id="history-list"><div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-title">No transfers yet</div></div></div></div>
</div>

<!-- PROFILE -->
<div class="screen" id="screen-profile">
  <div class="topbar"><span style="width:60px"></span><span class="topbar-title">My Profile</span><div style="width:60px"></div></div>
  <div class="scroll-area">
    <div class="profile-hero" id="profile-hero-content"></div>
    <div class="section-title">Account</div>
    <div class="menu-row" onclick="showScreen('screen-history');loadHistory()"><span class="menu-row-icon">ğŸ“‹</span><span class="menu-row-text">Transfer History</span><span class="menu-row-arrow">â€º</span></div>
    <div class="menu-row" onclick="showScreen('screen-agents');loadAgents()"><span class="menu-row-icon">ğŸ¤</span><span class="menu-row-text">Find an Agent</span><span class="menu-row-arrow">â€º</span></div>
    <div style="margin-top:8px">
      <div class="menu-row" onclick="logoutUser()" style="border-color:rgba(255,77,109,0.15)"><span class="menu-row-icon">ğŸšª</span><span class="menu-row-text" style="color:var(--red)">Sign Out</span><span class="menu-row-arrow" style="color:var(--red)">â€º</span></div>
    </div>
  </div>
  <div class="bottom-nav">
    <div class="nav-item" onclick="showScreen('screen-user-home')"><span class="nav-icon">ğŸ </span><span class="nav-label">Home</span></div>
    <div class="nav-item" onclick="showScreen('screen-send-money')"><span class="nav-icon">ğŸ“¤</span><span class="nav-label">Send</span></div>
    <div class="nav-center-wrap" onclick="showScreen('screen-agents');loadAgents()"><div class="nav-center-btn">ğŸ¤</div><span class="nav-center-label">Agents</span></div>
    <div class="nav-item" onclick="showScreen('screen-history');loadHistory()"><span class="nav-icon">ğŸ“‹</span><span class="nav-label">History</span></div>
    <div class="nav-item active"><span class="nav-icon">ğŸ‘¤</span><span class="nav-label">Profile</span></div>
  </div>
</div>

<!-- AGENT DASHBOARD -->
<div class="screen" id="screen-agent-home">
  <div class="topbar"><span class="topbar-logo">MoneyPon</span><span class="badge badge-gold">Agent</span><div class="topbar-icon-btn" onclick="logoutUser()">ğŸšª</div></div>
  <div class="scroll-area">
    <div class="agent-hero" id="agent-hero-content"></div>
    <div class="section-title">New Requests</div>
    <div id="agent-requests-list"><div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-title">No requests yet</div></div></div>
    <div class="section-title">Appointments</div>
    <div id="agent-appointments-list"><div class="empty-state"><div class="empty-icon">ğŸ“…</div><div class="empty-title">No appointments</div></div></div>
  </div>
  <div class="bottom-nav">
    <div class="nav-item active"><span class="nav-icon">ğŸ“‹</span><span class="nav-label">Requests</span></div>
    <div class="nav-center-wrap"><div class="nav-center-btn">ğŸ“</div><span class="nav-center-label">Status</span></div>
    <div class="nav-item" onclick="logoutUser()"><span class="nav-icon">ğŸšª</span><span class="nav-label">Sign Out</span></div>
  </div>
</div>

<!-- ADMIN DASHBOARD -->
<div class="screen" id="screen-admin-home">
  <div class="topbar"><span class="topbar-logo">MoneyPon</span><span class="badge badge-red">Admin</span><div class="topbar-icon-btn" onclick="logoutUser()">ğŸšª</div></div>
  <div class="scroll-area">
    <div class="admin-stats-grid">
      <div class="admin-stat-card" style="border-color:rgba(240,180,41,0.2)"><div class="admin-stat-icon">ğŸ’°</div><div class="admin-stat-val" id="admin-total-volume">$0</div><div class="admin-stat-lbl">Total Volume</div></div>
      <div class="admin-stat-card" style="border-color:rgba(0,194,122,0.2)"><div class="admin-stat-icon">ğŸ“ˆ</div><div class="admin-stat-val" id="admin-fees-earned">$0</div><div class="admin-stat-lbl">Your Fees (15%)</div></div>
      <div class="admin-stat-card"><div class="admin-stat-icon">ğŸ”„</div><div class="admin-stat-val" id="admin-total-tx">0</div><div class="admin-stat-lbl">Total Transfers</div></div>
      <div class="admin-stat-card"><div class="admin-stat-icon">â³</div><div class="admin-stat-val" id="admin-pending-tx">0</div><div class="admin-stat-lbl">Pending Release</div></div>
    </div>
    <div class="section-title">â³ Agent Applications</div>
    <div id="admin-agent-applications"><div class="empty-state" style="padding:20px"><div class="empty-title">No pending applications</div></div></div>
    <div class="section-title">ğŸ” Pending Release</div>
    <div id="admin-pending-transactions"><div class="empty-state" style="padding:20px"><div class="empty-title">No transfers awaiting release</div></div></div>
    <div class="section-title">âœ… Zelle Sent â€” Mark Complete</div>
    <div id="admin-processing-transactions"><div class="empty-state" style="padding:20px"><div class="empty-title">No transfers in processing</div></div></div>
    <div class="section-title">ğŸ‘¥ All Agents</div>
    <div id="admin-all-agents"><div class="empty-state" style="padding:20px"><div class="empty-title">No agents yet</div></div></div>
    <div class="section-title">ğŸ“‹ All Transactions</div>
    <div id="admin-all-transactions"><div class="empty-state" style="padding:20px"><div class="empty-title">No transactions yet</div></div></div>
    <div style="height:30px"></div>
  </div>
</div>

<!-- PENDING -->
<div class="screen" id="screen-pending">
  <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:32px;text-align:center">
    <div style="font-size:3rem;margin-bottom:16px;animation:float 3s ease-in-out infinite">â³</div>
    <div style="font-family:'Playfair Display',serif;font-size:1.4rem;font-weight:900;background:linear-gradient(135deg,var(--gold),var(--green2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:8px">Application Submitted!</div>
    <div style="font-size:0.85rem;color:var(--muted);line-height:1.7;margin-bottom:24px">Your agent application is being reviewed.<br>You'll be notified once approved (24-48 hours).</div>
    <button class="btn btn-outline" onclick="logoutUser()">Back to Home</button>
  </div>
</div>

</div><!-- end #app -->

<script>
// ===== SUPABASE SETUP =====
const _url='https://wjlcaxyiiswjvkortvuz.supabase.co';
const _key='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndqbGNheHlpaXN3anZrb3J0dnV6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwMzcyMTgsImV4cCI6MjA4NzYxMzIxOH0.rBkgfAewXWuZjEdfVcDQAOuwxHXWt4QhONE9Wmgf9ro';
const ADMIN_EMAIL='jolyjehiel@gmail.com';

// Load Supabase dynamically
let sb;
function loadSupabase(){
  return new Promise((resolve,reject)=>{
    const s=document.createElement('script');
    s.src='https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.3/dist/umd/supabase.min.js';
    s.onload=()=>{sb=supabase.createClient(_url,_key);resolve();};
    s.onerror=()=>{
      // fallback CDN
      const s2=document.createElement('script');
      s2.src='https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js';
      s2.onload=()=>{sb=supabase.createClient(_url,_key);resolve();};
      s2.onerror=reject;
      document.head.appendChild(s2);
    };
    document.head.appendChild(s);
  });
}

// ===== STATE =====
let currentUser=null,currentProfile=null,selectedAgent=null,selectedDate=null,selectedTime=null,pendingTxData=null,allAgentsData=[],screenHistory=['screen-splash'],currentTxId=null;

// ===== INIT =====
window.addEventListener('load',async()=>{
  const hideTimer=setTimeout(()=>{hideLoading();},4000);
  try{
    await loadSupabase();
    const{data:{session}}=await sb.auth.getSession();
    if(session?.user){currentUser=session.user;await loadProfile();}
  }catch(e){console.error('Init error:',e);showToast('Connection error');}
  clearTimeout(hideTimer);
  hideLoading();
});

function hideLoading(){document.getElementById('loading-overlay').classList.add('hidden');}

async function loadProfile(){
  if(!currentUser)return;
  const{data}=await sb.from('users').select('*').eq('id',currentUser.id).single();
  if(data){currentProfile=data;routeUser(data);}
  else showScreen('screen-splash');
}

function routeUser(p){
  if(p.role==='admin'){showScreen('screen-admin-home');loadAdminDashboard();}
  else if(p.role==='agent'){showScreen('screen-agent-home');loadAgentDashboard();}
  else if(p.role==='agent_pending')showScreen('screen-pending');
  else{showScreen('screen-user-home');loadUserHome();}
}

// ===== NAV =====
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  const t=document.getElementById(id);
  if(t){t.classList.add('active');if(screenHistory[screenHistory.length-1]!==id)screenHistory.push(id);t.querySelector('.scroll-area')?.scrollTo(0,0);}
}
function goBack(){screenHistory.pop();showScreen(screenHistory[screenHistory.length-1]||'screen-splash');}

// ===== AUTH =====
async function loginUser(){
  const email=document.getElementById('login-email').value.trim();
  const pass=document.getElementById('login-password').value;
  if(!email||!pass){showToast('Please fill in all fields');return;}
  showToast('Signing in...');
  const{data,error}=await sb.auth.signInWithPassword({email,password:pass});
  if(error){showToast('Error: '+error.message);return;}
  currentUser=data.user;await loadProfile();
}

async function loginAsAdmin(){
  const email=document.getElementById('login-email').value.trim();
  const pass=document.getElementById('login-password').value;
  if(!email||!pass){showToast('Please enter email and password');return;}
  showToast('Signing in...');
  const{data,error}=await sb.auth.signInWithPassword({email,password:pass});
  if(error){showToast('Error: '+error.message);return;}
  currentUser=data.user;
  await sb.from('users').upsert({id:currentUser.id,email,name:'Admin',role:'admin',status:'active'});
  currentProfile={role:'admin',name:'Admin',email};
  showScreen('screen-admin-home');loadAdminDashboard();
}

async function registerUser(){
  const name=document.getElementById('reg-name').value.trim();
  const email=document.getElementById('reg-email').value.trim();
  const phone=document.getElementById('reg-phone').value.trim();
  const pass=document.getElementById('reg-password').value;
  const role=document.getElementById('reg-role').value;
  if(!name||!email||!phone||!pass){showToast('Please fill in all fields');return;}
  if(pass.length<6){showToast('Password must be 6+ characters');return;}
  showToast('Creating account...');
  const{data,error}=await sb.auth.signUp({email,password:pass});
  if(error){showToast('Error: '+error.message);return;}
  currentUser=data.user;
  const profile={id:currentUser.id,name,email,phone,role,status:role==='agent_pending'?'pending':'active',total_sent:0,total_transactions:0,earnings:0,rating:5.0,available:true};
  if(role==='agent_pending'){profile.location=document.getElementById('reg-location').value;profile.zelle=document.getElementById('reg-zelle').value;}
  await sb.from('users').insert(profile);
  currentProfile=profile;showToast('Account created!');routeUser(profile);
}

async function logoutUser(){
  await sb.auth.signOut();currentUser=null;currentProfile=null;screenHistory=['screen-splash'];showScreen('screen-splash');showToast('Signed out');
}

function toggleAgentFields(){document.getElementById('agent-extra').style.display=document.getElementById('reg-role').value==='agent_pending'?'block':'none';}

// ===== USER HOME =====
async function loadUserHome(){
  if(!currentProfile)return;
  document.getElementById('home-user-name').textContent=currentProfile.name||'User';
  document.getElementById('home-total-sent').textContent='$'+(currentProfile.total_sent||0).toFixed(2);
  const{data}=await sb.from('transactions').select('id,recipient_name,amount,status,created_at').eq('sender_id',currentUser.id).order('created_at',{ascending:false}).limit(5);
  const list=document.getElementById('home-tx-list');
  if(!data||!data.length){list.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-title">No transfers yet</div><div class="empty-sub">Start your first one!</div></div>';return;}
  list.innerHTML=data.map(d=>`<div class="tx-item" onclick="viewTransfer('${d.id}')"><div class="tx-icon-wrap" style="background:rgba(0,194,122,0.1)">ğŸ“¤</div><div class="tx-info"><div class="tx-title">To ${d.recipient_name||'Unknown'}</div><div class="tx-date">${formatDate(d.created_at)} â€¢ ${d.status}</div></div><div class="tx-amount" style="color:${d.status==='completed'?'var(--green2)':d.status==='flagged'?'var(--red)':'var(--gold)'}">$${d.amount}</div></div>`).join('');
}

function loadProfileHero(){
  if(!currentProfile)return;
  document.getElementById('profile-hero-content').innerHTML=`<div class="profile-avatar">ğŸ‘¤</div><div class="profile-name">${currentProfile.name||'User'}</div><div class="profile-email">${currentProfile.email||''}</div><div class="profile-stats"><div class="profile-stat"><div class="v">$${currentProfile.total_sent||0}</div><div class="l">Total Sent</div></div><div class="profile-stat"><div class="v">${currentProfile.total_transactions||0}</div><div class="l">Transfers</div></div></div>`;
}

// ===== SEND MONEY =====
function calculateTransfer(){
  const a=parseFloat(document.getElementById('send-amount').value)||0;
  const f=a*0.15;const r=a-f;
  document.getElementById('receive-amount').textContent=r.toFixed(2);
  document.getElementById('fee-send').textContent='$'+a.toFixed(2);
  document.getElementById('fee-amount').textContent='-$'+f.toFixed(2);
  document.getElementById('fee-receive').textContent='$'+r.toFixed(2);
}

async function proceedToAgent(){
  const amount=parseFloat(document.getElementById('send-amount').value);
  const recipientName=document.getElementById('recipient-name').value.trim();
  const recipientZelle=document.getElementById('recipient-zelle').value.trim();
  if(!amount||amount<10){showToast('Minimum transfer is $10');return;}
  if(!recipientName){showToast('Please enter recipient name');return;}
  if(!recipientZelle){showToast('Please enter recipient Zelle');return;}
  pendingTxData={amount,recipientName,recipientZelle,note:document.getElementById('send-note').value};
  showScreen('screen-agents');loadAgents();
}

// ===== AGENTS =====
async function loadAgents(){
  const list=document.getElementById('agents-list');
  list.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted)">â³ Loading agents...</div>';
  const{data,error}=await sb.from('users').select('*').eq('role','agent').eq('status','active');
  if(error||!data){list.innerHTML='<div class="empty-state"><div class="empty-icon">âš ï¸</div><div class="empty-title">Could not load agents</div></div>';return;}
  allAgentsData=data;renderAgents(data);
}

function renderAgents(agents){
  const list=document.getElementById('agents-list');
  if(!agents.length){list.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ¤</div><div class="empty-title">No agents available yet</div></div>';return;}
  list.innerHTML=agents.map(a=>`<div class="agent-card">
    <div class="agent-card-top" onclick="viewAgentProfile('${a.id}')">
      <div class="agent-avatar">ğŸ¤<div class="agent-online-dot" style="background:${a.available!==false?'var(--green2)':'var(--muted)'}"></div></div>
      <div class="agent-card-info">
        <div class="agent-card-name">${a.name||'Agent'}</div>
        <div class="agent-card-location">ğŸ“ ${a.location||'Unknown'}</div>
        <div style="font-size:0.68rem;color:var(--gold);font-weight:700">â­ ${(a.rating||5.0).toFixed(1)} â€¢ ${a.total_transactions||0} transfers</div>
      </div>
    </div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button style="flex:1;padding:9px;background:rgba(0,194,122,0.1);border:1px solid rgba(0,194,122,0.2);color:var(--green2);border-radius:10px;font-size:0.78rem;font-weight:700;cursor:pointer" onclick="openCallModal('${a.id}')">ğŸ“ Call Agent</button>
      <button style="flex:1;padding:9px;background:linear-gradient(135deg,var(--green),var(--green2));border:none;color:#fff;border-radius:10px;font-size:0.78rem;font-weight:700;cursor:pointer" onclick="goToSchedule('${a.id}')">ğŸ“… Book</button>
    </div>
  </div>`).join('');
}

function filterAgents(q){renderAgents(allAgentsData.filter(a=>a.name?.toLowerCase().includes(q.toLowerCase())||a.location?.toLowerCase().includes(q.toLowerCase())));}
function filterByCountry(type,el){
  document.querySelectorAll('.filter-chip').forEach(c=>c.classList.remove('active'));el.classList.add('active');
  let f=allAgentsData;
  if(type==='haiti')f=allAgentsData.filter(a=>a.location?.includes('Haiti'));
  else if(type==='usa')f=allAgentsData.filter(a=>a.location?.includes('USA'));
  else if(type==='online')f=allAgentsData.filter(a=>a.available!==false);
  renderAgents(f);
}

function viewAgentProfile(agentId){
  const a=allAgentsData.find(x=>x.id===agentId);if(!a)return;selectedAgent=a;
  document.getElementById('agent-profile-content').innerHTML=`
    <div style="margin:16px;background:linear-gradient(135deg,#002d18,#003d22);border-radius:20px;padding:20px;text-align:center;border:1px solid rgba(0,194,122,0.15)">
      <div style="width:64px;height:64px;background:rgba(0,194,122,0.15);border-radius:18px;display:flex;align-items:center;justify-content:center;font-size:1.8rem;margin:0 auto 10px">ğŸ¤</div>
      <div style="font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:900;margin-bottom:4px">${a.name||'Agent'}</div>
      <div style="font-size:0.75rem;color:var(--muted);margin-bottom:12px">ğŸ“ ${a.location||'Unknown'}</div>
      <div style="display:flex">
        <div style="flex:1;text-align:center;padding:8px"><div style="font-family:'Playfair Display',serif;font-size:1rem;font-weight:900;color:var(--gold)">${a.total_transactions||0}</div><div style="font-size:0.58rem;color:rgba(255,255,255,0.4)">Transfers</div></div>
        <div style="flex:1;text-align:center;padding:8px;border-left:1px solid rgba(255,255,255,0.08)"><div style="font-family:'Playfair Display',serif;font-size:1rem;font-weight:900;color:var(--gold)">${(a.rating||5.0).toFixed(1)}â­</div><div style="font-size:0.58rem;color:rgba(255,255,255,0.4)">Rating</div></div>
        <div style="flex:1;text-align:center;padding:8px;border-left:1px solid rgba(255,255,255,0.08)"><div style="font-size:1rem">${a.available!==false?'ğŸŸ¢':'ğŸ”´'}</div><div style="font-size:0.58rem;color:rgba(255,255,255,0.4)">${a.available!==false?'Online':'Busy'}</div></div>
      </div>
    </div>
    <div style="margin:0 16px">
      <div style="background:var(--card);border-radius:14px;padding:14px;border:1px solid var(--border2)">
        <div class="info-row"><span class="info-row-label">ğŸ“ Location</span><span class="info-row-value">${a.location||'N/A'}</span></div>
        <div class="info-row"><span class="info-row-label">ğŸ“ Phone</span><span class="info-row-value" style="color:var(--green2)">${a.phone||'N/A'}</span></div>
        <div class="info-row"><span class="info-row-label">ğŸ’³ Zelle/MonCash</span><span class="info-row-value">${a.zelle||'N/A'}</span></div>
        <div class="info-row"><span class="info-row-label">â° Hours</span><span class="info-row-value">${a.hours||'8AM - 8PM'}</span></div>
      </div>
      <div style="margin-top:12px;display:flex;gap:10px">
        <button class="btn btn-outline" style="flex:1" onclick="openCallModal('${a.id}')">ğŸ“ Call</button>
        <button class="btn btn-green" style="flex:1" onclick="goToSchedule('${a.id}')">ğŸ“… Book</button>
      </div>
    </div>`;
  showScreen('screen-agent-profile');
}

// ===== CALL =====
function openCallModal(agentId){
  const a=allAgentsData.find(x=>x.id===agentId);if(!a)return;
  document.getElementById('modal-agent-info').innerHTML=`<div style="background:var(--card);border-radius:12px;padding:14px;border:1px solid var(--border)"><div style="font-size:0.9rem;font-weight:700;margin-bottom:4px">${a.name}</div><div style="font-size:0.75rem;color:var(--muted);margin-bottom:8px">ğŸ“ ${a.location}</div><div style="font-size:1rem;color:var(--green2);font-weight:700">ğŸ“ ${a.phone||'N/A'}</div></div>`;
  document.getElementById('modal-call-btn').setAttribute('data-phone',a.phone||'');
  openModal('modal-call-agent');
}
function callAgent(){const p=document.getElementById('modal-call-btn').getAttribute('data-phone');if(p)window.location.href='tel:'+p;else showToast('No phone number');closeModal('modal-call-agent');}

// ===== SCHEDULE =====
function goToSchedule(agentId){
  const a=allAgentsData.find(x=>x.id===agentId);if(!a)return;selectedAgent=a;
  document.getElementById('schedule-agent-mini').innerHTML=`<div style="background:var(--card);border-radius:12px;padding:12px;display:flex;align-items:center;gap:12px;border:1px solid rgba(0,194,122,0.12);margin-bottom:4px"><div style="width:36px;height:36px;background:rgba(0,194,122,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center">ğŸ¤</div><div><div style="font-size:0.85rem;font-weight:700">${a.name}</div><div style="font-size:0.65rem;color:var(--muted)">ğŸ“ ${a.location}</div></div></div>`;
  renderDateGrid();renderTimeGrid();showScreen('screen-schedule');
}

function renderDateGrid(){
  const days=['Su','Mo','Tu','We','Th','Fr','Sa'];const today=new Date();
  document.getElementById('date-grid').innerHTML=Array.from({length:14},(_,i)=>{const d=new Date(today);d.setDate(today.getDate()+i);const s=d.toISOString().split('T')[0];return`<div class="date-cell" onclick="selectDate('${s}',this)"><div class="date-day">${days[d.getDay()]}</div><div class="date-num">${d.getDate()}</div></div>`;}).join('');
}
function renderTimeGrid(){
  ['8:00 AM','9:00 AM','10:00 AM','11:00 AM','12:00 PM','1:00 PM','2:00 PM','3:00 PM','4:00 PM','5:00 PM','6:00 PM','7:00 PM'].forEach(t=>{const el=document.createElement('div');el.className='time-cell';el.textContent=t;el.onclick=()=>selectTime(t,el);document.getElementById('time-grid').innerHTML='';});
  document.getElementById('time-grid').innerHTML=['8:00 AM','9:00 AM','10:00 AM','11:00 AM','12:00 PM','1:00 PM','2:00 PM','3:00 PM','4:00 PM','5:00 PM','6:00 PM','7:00 PM'].map(t=>`<div class="time-cell" onclick="selectTime('${t}',this)">${t}</div>`).join('');
}
function selectDate(d,el){document.querySelectorAll('.date-cell').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');selectedDate=d;}
function selectTime(t,el){document.querySelectorAll('.time-cell').forEach(c=>c.classList.remove('selected'));el.classList.add('selected');selectedTime=t;}

function showBookingConfirm(){
  const amount=document.getElementById('appt-amount').value;
  if(!selectedDate){showToast('Please select a date');return;}
  if(!selectedTime){showToast('Please select a time');return;}
  if(!amount||amount<10){showToast('Please enter amount');return;}
  document.getElementById('book-summary').innerHTML=`<div style="background:var(--card);border-radius:12px;padding:14px;border:1px solid var(--border)"><div class="fee-row"><span class="fee-label">Agent</span><span class="fee-value">${selectedAgent?.name}</span></div><div class="fee-row"><span class="fee-label">Date</span><span class="fee-value">${selectedDate}</span></div><div class="fee-row"><span class="fee-label">Time</span><span class="fee-value">${selectedTime}</span></div><div class="fee-row"><span class="fee-label">Amount</span><span class="fee-value" style="color:var(--gold)">$${amount}</span></div></div>`;
  openModal('modal-book-confirm');
}

async function confirmBooking(){
  const amount=parseFloat(document.getElementById('appt-amount').value);
  const note=document.getElementById('appt-note').value;
  if(!currentUser||!selectedAgent)return;
  await sb.from('appointments').insert({user_id:currentUser.id,user_name:currentProfile.name,agent_id:selectedAgent.id,agent_name:selectedAgent.name,agent_location:selectedAgent.location,date:selectedDate,time:selectedTime,amount,note,status:'scheduled'});
  const{data:tx}=await sb.from('transactions').insert({sender_id:currentUser.id,sender_name:currentProfile.name,agent_id:selectedAgent.id,agent_name:selectedAgent.name,amount,fee:amount*0.15,receive_amount:amount*0.85,recipient_name:pendingTxData?.recipientName||'N/A',recipient_zelle:pendingTxData?.recipientZelle||'N/A',note,status:'scheduled'}).select().single();
  closeModal('modal-book-confirm');showToast('âœ… Appointment booked!');
  if(tx)viewTransfer(tx.id);
}

// ===== TRACK =====
async function viewTransfer(txId){
  currentTxId=txId;showScreen('screen-track');
  const content=document.getElementById('track-content');
  content.innerHTML='<div style="text-align:center;padding:40px;color:var(--muted)">Loading...</div>';
  const{data:d}=await sb.from('transactions').select('*').eq('id',txId).single();
  if(!d){content.innerHTML='<div class="empty-state"><div class="empty-title">Transfer not found</div></div>';return;}
  const statusMap={scheduled:{icon:'ğŸ“…',label:'Scheduled',color:'var(--blue)'},cash_confirmed:{icon:'ğŸ’µ',label:'Cash Confirmed',color:'var(--gold)'},processing:{icon:'ğŸ”„',label:'Zelle Being Sent',color:'var(--gold)'},completed:{icon:'âœ…',label:'Completed',color:'var(--green2)'},flagged:{icon:'ğŸš©',label:'Flagged',color:'var(--red)'},declined:{icon:'âŒ',label:'Declined',color:'var(--red)'}};
  const st=statusMap[d.status]||statusMap.scheduled;
  const steps=[
    {label:'Transfer Requested',sub:formatDate(d.created_at),done:true},
    {label:'Appointment Scheduled',sub:d.agent_name?`With ${d.agent_name}`:'Agent assigned',done:true},
    {label:'Cash Received by Agent',sub:d.cash_confirmed_at?formatDate(d.cash_confirmed_at):'Waiting for agent...',done:['cash_confirmed','processing','completed'].includes(d.status),active:d.status==='scheduled'},
    {label:'Admin Verified & Released',sub:d.released_at?formatDate(d.released_at):'Awaiting admin review...',done:['processing','completed'].includes(d.status),active:d.status==='cash_confirmed'},
    {label:'Zelle Sent âœ…',sub:d.completed_at?formatDate(d.completed_at):'Pending...',done:d.status==='completed',active:d.status==='processing'}
  ];
  content.innerHTML=`
    <div style="margin:16px;background:linear-gradient(135deg,#002d18,#003d22);border-radius:18px;padding:18px;text-align:center;border:1px solid rgba(0,194,122,0.15)">
      <div style="font-size:2.2rem;margin-bottom:8px">${st.icon}</div>
      <div style="font-size:0.65rem;color:rgba(255,255,255,0.35);margin-bottom:4px;letter-spacing:1px;text-transform:uppercase">TXN-${txId.slice(0,8).toUpperCase()}</div>
      <div style="font-family:'Playfair Display',serif;font-size:1.6rem;font-weight:900;color:var(--gold);margin-bottom:8px">$${d.amount} â†’ $${(d.receive_amount||d.amount*0.85).toFixed(2)}</div>
      <span class="badge" style="background:rgba(255,255,255,0.08);color:${st.color};border:1px solid ${st.color}40">${st.label}</span>
    </div>
    <div style="padding:0 16px">
      <div class="section-title" style="padding:0">Transfer Details</div>
      <div style="background:var(--card);border-radius:14px;padding:14px;border:1px solid var(--border2);margin-bottom:14px">
        <div class="fee-row"><span class="fee-label">To</span><span class="fee-value">${d.recipient_name}</span></div>
        <div class="fee-row"><span class="fee-label">Zelle</span><span class="fee-value">${d.recipient_zelle}</span></div>
        <div class="fee-row"><span class="fee-label">You Sent</span><span class="fee-value">$${d.amount}</span></div>
        <div class="fee-row"><span class="fee-label">Fee (15%)</span><span class="fee-value" style="color:var(--red)">-$${(d.fee||d.amount*0.15).toFixed(2)}</span></div>
        <div class="fee-divider"></div>
        <div class="fee-total"><span>Recipient Gets</span><span class="fee-value">$${(d.receive_amount||d.amount*0.85).toFixed(2)}</span></div>
      </div>
      <div class="section-title" style="padding:0">Progress</div>
      <div style="margin-bottom:20px">
        ${steps.map((s,i)=>`<div class="tl-item"><div class="tl-left"><div class="tl-dot ${s.done?'done':s.active?'active':'waiting'}">${s.done?'âœ“':s.active?'â—':'â—‹'}</div>${i<steps.length-1?`<div class="tl-line ${s.done?'done':''}"></div>`:''}</div><div class="tl-right"><div class="tl-title ${s.active?'active':!s.done?'waiting':''}">${s.label}</div><div class="tl-sub">${s.sub}</div></div></div>`).join('')}
      </div>
    </div>`;
}

// ===== HISTORY =====
async function loadHistory(){
  if(!currentUser)return;
  const list=document.getElementById('history-list');
  list.innerHTML='<div style="text-align:center;padding:30px;color:var(--muted)">Loading...</div>';
  const{data}=await sb.from('transactions').select('*').eq('sender_id',currentUser.id).order('created_at',{ascending:false});
  if(!data||!data.length){list.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-title">No transfers yet</div></div>';return;}
  const badges={completed:'badge-green',flagged:'badge-red',processing:'badge-gold',cash_confirmed:'badge-gold',scheduled:'badge-blue',declined:'badge-red',pending:'badge-muted'};
  list.innerHTML=data.map(d=>`<div class="history-item" onclick="viewTransfer('${d.id}')"><div class="history-item-top"><span class="history-item-name">To ${d.recipient_name}</span><span class="badge ${badges[d.status]||'badge-muted'}">${d.status}</span></div><div class="history-item-bottom"><span class="history-item-meta">${formatDate(d.created_at)}</span><span class="history-item-amount">$${d.amount}</span></div></div>`).join('');
}

// ===== AGENT DASHBOARD =====
async function loadAgentDashboard(){
  if(!currentProfile)return;
  document.getElementById('agent-hero-content').innerHTML=`
    <div style="display:flex;align-items:center;gap:12px;margin-bottom:14px">
      <div style="width:44px;height:44px;background:rgba(240,180,41,0.15);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.3rem">ğŸ…</div>
      <div><div style="font-family:'Playfair Display',serif;font-size:1rem;font-weight:800;color:var(--gold)">${currentProfile.name}</div><div style="font-size:0.68rem;color:rgba(240,180,41,0.5)">ğŸ“ ${currentProfile.location||'Location not set'}</div></div>
    </div>
    <div style="display:flex;gap:8px">
      <div style="flex:1;background:rgba(255,255,255,0.05);border-radius:10px;padding:8px;text-align:center"><div style="font-family:'Playfair Display',serif;font-size:0.9rem;font-weight:800;color:var(--gold)">$${currentProfile.earnings||0}</div><div style="font-size:0.55rem;color:rgba(255,255,255,0.4)">Earnings</div></div>
      <div style="flex:1;background:rgba(255,255,255,0.05);border-radius:10px;padding:8px;text-align:center"><div style="font-family:'Playfair Display',serif;font-size:0.9rem;font-weight:800;color:var(--gold)">${currentProfile.total_transactions||0}</div><div style="font-size:0.55rem;color:rgba(255,255,255,0.4)">Done</div></div>
      <div style="flex:1;background:rgba(255,255,255,0.05);border-radius:10px;padding:8px;text-align:center"><div style="font-family:'Playfair Display',serif;font-size:0.9rem;font-weight:800;color:var(--gold)">${(currentProfile.rating||5.0).toFixed(1)}â­</div><div style="font-size:0.55rem;color:rgba(255,255,255,0.4)">Rating</div></div>
    </div>`;

  const{data:requests}=await sb.from('transactions').select('*').eq('agent_id',currentUser.id).eq('status','scheduled').order('created_at',{ascending:false});
  const reqList=document.getElementById('agent-requests-list');
  if(!requests||!requests.length){reqList.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ“­</div><div class="empty-title">No requests yet</div></div>';}
  else{
    const senderIds=[...new Set(requests.map(d=>d.sender_id))];
    const{data:senders}=await sb.from('users').select('id,name,phone').in('id',senderIds);
    const sMap={};(senders||[]).forEach(u=>sMap[u.id]=u);
    const{data:appts}=await sb.from('appointments').select('*').in('user_id',senderIds).eq('status','scheduled');
    const aMap={};(appts||[]).forEach(a=>aMap[a.user_id]=a);
    reqList.innerHTML=requests.map(d=>{
      const sender=sMap[d.sender_id]||{};const appt=aMap[d.sender_id]||{};
      return`<div class="request-card">
        <div class="request-card-top"><span class="request-ref">TXN-${d.id.slice(0,8).toUpperCase()}</span><span class="badge badge-gold">Scheduled</span></div>
        <div class="request-amount">$${d.amount} USD</div>
        <div style="font-size:0.7rem;color:var(--muted);margin-bottom:8px">ğŸ‡­ğŸ‡¹ Haiti â†’ ğŸ‡ºğŸ‡¸ USA â€¢ Zelle to ${d.recipient_name}</div>
        <div class="user-info-box">
          <div style="font-size:0.68rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px">ğŸ‘¤ User Info</div>
          <div style="font-size:0.82rem;font-weight:700;margin-bottom:4px">${sender.name||d.sender_name}</div>
          <div style="font-size:0.78rem;color:var(--green2);margin-bottom:${appt.date?'4px':'0'}">ğŸ“ ${sender.phone||'No phone provided'}</div>
          ${appt.date?`<div style="font-size:0.75rem;color:var(--gold);margin-top:4px">ğŸ“… ${appt.date} at ${appt.time}</div>`:''}
          ${appt.note?`<div style="font-size:0.72rem;color:var(--muted);margin-top:4px">ğŸ’¬ "${appt.note}"</div>`:''}
          ${d.note?`<div style="font-size:0.72rem;color:var(--muted);margin-top:4px">ğŸ“ ${d.note}</div>`:''}
        </div>
        <div class="request-btns">
          <button class="req-btn-confirm" onclick="openConfirmCash('${d.id}',${d.amount})">âœ… I Received Cash</button>
          <button class="req-btn-decline" onclick="declineRequest('${d.id}')">âœ• Decline</button>
        </div>
      </div>`;
    }).join('');
  }

  const{data:appts}=await sb.from('appointments').select('*').eq('agent_id',currentUser.id).order('created_at',{ascending:false});
  const apptList=document.getElementById('agent-appointments-list');
  if(!appts||!appts.length){apptList.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ“…</div><div class="empty-title">No appointments yet</div><div class="empty-sub">Users will book you from the agents list</div></div>';}
  else{
    const apptUserIds=[...new Set(appts.map(a=>a.user_id))];
    const{data:apptUsers}=await sb.from('users').select('id,phone,name').in('id',apptUserIds);
    const uMap={};(apptUsers||[]).forEach(u=>uMap[u.id]=u);
    apptList.innerHTML=appts.map(d=>{
      const u=uMap[d.user_id]||{};
      const phone=u.phone||'No phone';
      return`<div class="request-card">
        <div class="request-card-top"><span class="request-ref">APT-${d.id.slice(0,8).toUpperCase()}</span><span class="badge badge-blue">${d.status||'scheduled'}</span></div>
        <div class="request-amount">$${d.amount} Cash</div>
        <div class="user-info-box" style="background:rgba(59,130,246,0.06);border-color:rgba(59,130,246,0.15)">
          <div style="font-size:0.68rem;color:var(--muted);font-weight:700;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px">ğŸ‘¤ User Info</div>
          <div style="font-size:0.82rem;font-weight:700;margin-bottom:4px">${u.name||d.user_name}</div>
          <div style="font-size:0.78rem;color:var(--blue);margin-bottom:4px">ğŸ“ ${phone}</div>
          <div style="font-size:0.75rem;color:var(--gold)">ğŸ“… ${d.date} at ${d.time}</div>
          ${d.note?`<div style="font-size:0.72rem;color:var(--muted);margin-top:4px">ğŸ’¬ "${d.note}"</div>`:''}
        </div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button style="flex:1;padding:8px;background:rgba(59,130,246,0.15);border:1px solid rgba(59,130,246,0.3);color:var(--blue);border-radius:10px;font-size:0.78rem;font-weight:700;cursor:pointer" onclick="window.location.href='tel:${phone}'">ğŸ“ Call User</button>
        </div>
      </div>`;
    }).join('');
  }
}

function openConfirmCash(txId,amount){document.getElementById('confirm-cash-txid').value=txId;document.getElementById('confirm-cash-amount').value=amount;openModal('modal-confirm-cash');}
async function submitCashConfirmation(){
  const txId=document.getElementById('confirm-cash-txid').value;
  const amount=parseFloat(document.getElementById('confirm-cash-amount').value);
  if(!amount){showToast('Please enter the amount');return;}
  await sb.from('transactions').update({status:'cash_confirmed',cash_confirmed_at:new Date().toISOString(),confirmed_amount:amount}).eq('id',txId);
  closeModal('modal-confirm-cash');showToast('âœ… Cash confirmed! Admin notified.');loadAgentDashboard();
}
async function declineRequest(txId){await sb.from('transactions').update({status:'declined'}).eq('id',txId);showToast('Request declined');loadAgentDashboard();}

// ===== ADMIN =====
async function loadAdminDashboard(){
  const{data:txAll}=await sb.from('transactions').select('*');
  let vol=0,fees=0,pending=0;
  (txAll||[]).forEach(t=>{vol+=t.amount||0;fees+=(t.amount||0)*0.15;if(t.status==='cash_confirmed')pending++;});
  document.getElementById('admin-total-volume').textContent='$'+vol.toFixed(0);
  document.getElementById('admin-fees-earned').textContent='$'+fees.toFixed(0);
  document.getElementById('admin-total-tx').textContent=txAll?.length||0;
  document.getElementById('admin-pending-tx').textContent=pending;

  const{data:apps}=await sb.from('users').select('*').eq('role','agent_pending');
  document.getElementById('admin-agent-applications').innerHTML=(!apps||!apps.length)?'<div class="empty-state" style="padding:20px"><div class="empty-title">No pending applications</div></div>':apps.map(a=>`<div class="admin-action-row"><div class="admin-action-info"><div class="admin-action-name">${a.name} <span class="badge badge-muted">Pending</span></div><div class="admin-action-sub">ğŸ“ ${a.location||'?'} â€¢ ğŸ“ ${a.phone||'?'}</div></div><div class="admin-action-btns"><button class="admin-btn-approve" onclick="approveAgent('${a.id}')">âœ“ Approve</button><button class="admin-btn-reject" onclick="rejectAgent('${a.id}')">âœ— Reject</button></div></div>`).join('');

  const pendingTxs=(txAll||[]).filter(t=>t.status==='cash_confirmed');
  document.getElementById('admin-pending-transactions').innerHTML=!pendingTxs.length?'<div class="empty-state" style="padding:20px"><div class="empty-title">None awaiting release</div></div>':pendingTxs.map(d=>`<div class="admin-action-row"><div class="admin-action-info"><div class="admin-action-name">$${d.amount} â†’ $${(d.receive_amount||d.amount*0.85).toFixed(2)} <span class="badge badge-gold">Cash Confirmed</span></div><div class="admin-action-sub">To: ${d.recipient_name} â€¢ ${d.recipient_zelle}</div></div><div class="admin-action-btns"><button class="admin-btn-approve" onclick="openReleaseModal('${d.id}')">Release</button></div></div>`).join('');

  const processingTxs=(txAll||[]).filter(t=>t.status==='processing');
  document.getElementById('admin-processing-transactions').innerHTML=!processingTxs.length?'<div class="empty-state" style="padding:20px"><div class="empty-title">No transfers in processing</div></div>':processingTxs.map(d=>`<div class="admin-action-row"><div class="admin-action-info"><div class="admin-action-name">$${d.amount} â†’ $${(d.receive_amount||d.amount*0.85).toFixed(2)} <span class="badge badge-blue">Zelle Sent</span></div><div class="admin-action-sub">To: ${d.recipient_name} â€¢ ${d.recipient_zelle}</div></div><div class="admin-action-btns"><button class="admin-btn-approve" onclick="markComplete('${d.id}')">âœ… Mark Done</button></div></div>`).join('');

  const{data:agents}=await sb.from('users').select('*').in('role',['agent','agent_pending']);
  document.getElementById('admin-all-agents').innerHTML=(!agents||!agents.length)?'<div class="empty-state" style="padding:20px"><div class="empty-title">No agents yet</div></div>':agents.map(a=>`<div class="admin-action-row"><div class="admin-action-info"><div class="admin-action-name">${a.name} <span class="badge ${a.status==='active'?'badge-green':a.status==='blocked'?'badge-red':'badge-muted'}">${a.status||a.role}</span></div><div class="admin-action-sub">ğŸ“ ${a.location||'?'} â€¢ ${a.total_transactions||0} transfers</div></div><div class="admin-action-btns">${a.status==='active'?`<button class="admin-btn-block" onclick="blockAgent('${a.id}')">Block</button>`:''}${a.status==='blocked'?`<button class="admin-btn-approve" onclick="unblockAgent('${a.id}')">Unblock</button>`:''}</div></div>`).join('');

  const sorted=(txAll||[]).sort((a,b)=>new Date(b.created_at)-new Date(a.created_at));
  document.getElementById('admin-all-transactions').innerHTML=!sorted.length?'<div class="empty-state" style="padding:20px"><div class="empty-title">No transactions yet</div></div>':sorted.slice(0,20).map(d=>`<div class="admin-action-row"><div class="admin-action-info"><div class="admin-action-name">$${d.amount} <span class="badge ${d.status==='completed'?'badge-green':d.status==='flagged'?'badge-red':'badge-gold'}">${d.status}</span></div><div class="admin-action-sub">From: ${d.sender_name} â†’ To: ${d.recipient_name}</div></div><div class="admin-action-btns"><button class="admin-btn-approve" onclick="viewTransfer('${d.id}')">View</button></div></div>`).join('');
}

async function markComplete(txId){await sb.from('transactions').update({status:'completed',completed_at:new Date().toISOString()}).eq('id',txId);showToast('âœ… Transfer marked complete!');loadAdminDashboard();}
async function approveAgent(uid){await sb.from('users').update({role:'agent',status:'active'}).eq('id',uid);showToast('âœ… Agent approved!');loadAdminDashboard();}
async function rejectAgent(uid){await sb.from('users').update({role:'user',status:'rejected'}).eq('id',uid);showToast('Agent rejected');loadAdminDashboard();}
async function blockAgent(uid){await sb.from('users').update({status:'blocked'}).eq('id',uid);showToast('ğŸš« Agent blocked');loadAdminDashboard();}
async function unblockAgent(uid){await sb.from('users').update({status:'active'}).eq('id',uid);showToast('âœ… Agent unblocked');loadAdminDashboard();}
function openReleaseModal(txId){currentTxId=txId;document.getElementById('release-info').innerHTML=`<div style="background:var(--card);border-radius:10px;padding:12px;border:1px solid var(--border)"><div style="font-size:0.8rem;color:var(--muted);margin-bottom:4px">Transaction</div><div style="font-size:0.85rem;font-weight:700;font-family:monospace">TXN-${txId.slice(0,8).toUpperCase()}</div></div>`;openModal('modal-admin-release');}
async function releaseTx(){if(!currentTxId)return;await sb.from('transactions').update({status:'processing',released_at:new Date().toISOString()}).eq('id',currentTxId);closeModal('modal-admin-release');showToast('ğŸš€ Released!');loadAdminDashboard();}
async function flagTx(){if(!currentTxId)return;await sb.from('transactions').update({status:'flagged',flagged_at:new Date().toISOString()}).eq('id',currentTxId);closeModal('modal-admin-release');showToast('ğŸš© Flagged');loadAdminDashboard();}

// ===== MODALS =====
function openModal(id){document.getElementById(id).classList.add('open');}
function closeModal(id){document.getElementById(id).classList.remove('open');}
document.querySelectorAll('.modal-overlay').forEach(o=>o.addEventListener('click',e=>{if(e.target===o)o.classList.remove('open');}));

// ===== UTILS =====
function showToast(msg){const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}
function formatDate(ts){if(!ts)return'Just now';return new Date(ts).toLocaleDateString('en-US',{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});}
</script>
</body>
</html>
